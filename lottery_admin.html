<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ½çç³»çµ±ç®¡ç†å¾Œå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #666;
            font-weight: 500;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 20px;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .prize-list {
            margin-bottom: 30px;
        }

        .prize-item {
            display: grid;
            grid-template-columns: 80px 1fr 1fr 100px 80px 80px 120px;
            gap: 15px;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .prize-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .prize-item.bonus-prize {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
        }

        .prize-header {
            display: grid;
            grid-template-columns: 80px 1fr 1fr 100px 80px 80px 120px;
            gap: 15px;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            background: #667eea;
            color: white;
            border-radius: 10px;
            font-weight: bold;
        }

        .prize-order {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
            text-align: center;
        }

        .prize-name, .prize-content {
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .rules-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .rule-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .rule-item:last-child {
            border-bottom: none;
        }

        .department-quota {
            display: grid;
            grid-template-columns: 200px 150px 100px 1fr;
            gap: 15px;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .employee-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .employee-table th,
        .employee-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .employee-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .employee-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .lottery-engine {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .engine-status {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .winners-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .winner-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .bonus-control {
            background: linear-gradient(135deg, #dc3545, #e91e63);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            margin-bottom: 10px;
        }

        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .file-upload-label:hover {
            background: #5a6fd8;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #28a745;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.warning {
            background: #ffc107;
            color: #212529;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .bonus-settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .range-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-input input[type="range"] {
            flex: 1;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .clear-test-section {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .clear-test-section h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .clear-test-section ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .prize-item, .prize-header {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ æŠ½çç³»çµ±ç®¡ç†å¾Œå°</h1>
            <p>å®Œæ•´ç®¡ç†ç³»çµ± + æ ¸å¿ƒæŠ½çé‚è¼¯å¼•æ“ (HTMLä¿®å¾©ç‰ˆ)</p>
        </div>

        <!-- çµ±è¨ˆå„€è¡¨æ¿ -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="totalEmployees">0</h3>
                <p>ç¸½å“¡å·¥æ•¸</p>
            </div>
            <div class="stat-card">
                <h3 id="totalPrizes">0</h3>
                <p>çé …æ•¸</p>
            </div>
            <div class="stat-card">
                <h3 id="totalWinners">0</h3>
                <p>ä¸­çäººæ•¸</p>
            </div>
            <div class="stat-card">
                <h3 id="totalQuota">0</h3>
                <p>ç¸½åé¡</p>
            </div>
        </div>

        <!-- æŠ½çå¼•æ“ç‹€æ…‹ -->
        <div class="lottery-engine">
            <div class="engine-status">
                <div class="status-indicator"></div>
                <h3>æŠ½çå¼•æ“ç‹€æ…‹</h3>
                <span id="engineStatus">ç­‰å¾…ä¸­</span>
            </div>
            <div class="grid-2">
                <div>
                    <strong>ç•¶å‰çé …:</strong> <span id="currentPrize">ç„¡</span>
                </div>
                <div>
                    <strong>ç¬¦åˆæ¢ä»¶å“¡å·¥:</strong> <span id="eligibleCount">0</span>
                </div>
            </div>
        </div>

        <!-- åŠ ç¢¼çæ§åˆ¶ -->
        <div class="bonus-control">
            <h3>ğŸ åŠ ç¢¼çæ§åˆ¶</h3>
            <p>ç‹€æ…‹: <span id="bonusStatus">æœªå•Ÿå‹•</span></p>
            <button class="btn btn-warning" id="activateBonusBtn">ğŸš€ å•Ÿå‹•åŠ ç¢¼ç</button>
            <button class="btn btn-info" id="bonusSettingsBtn">âš™ï¸ åŠ ç¢¼çè¨­å®š</button>
        </div>

        <!-- é¸é …å¡ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('prizes')">ğŸ† çé …ç®¡ç†</button>
            <button class="tab" onclick="switchTab('employees')">ğŸ‘¥ å“¡å·¥ç®¡ç†</button>
            <button class="tab" onclick="switchTab('rules')">ğŸ“‹ æŠ½çè¦å‰‡</button>
            <button class="tab" onclick="switchTab('winners')">ğŸ‰ ä¸­çè¨˜éŒ„</button>
            <button class="tab" onclick="switchTab('settings')">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </div>

        <!-- çé …ç®¡ç† -->
        <div id="prizes" class="tab-content active">
            <div class="section-title">ğŸ† çé …ç®¡ç†ï¼ˆæŒ‰æŠ½çé †åºæ’åˆ—ï¼‰</div>
            
            <div class="prize-list">
                <div class="prize-header">
                    <div>æŠ½çé †åº</div>
                    <div>çé …åç¨±</div>
                    <div>çé …å…§å®¹</div>
                    <div>åé¡</div>
                    <div>å·²æŠ½å‡º</div>
                    <div>å‰©é¤˜</div>
                    <div>æ“ä½œ</div>
                </div>
                <div id="prizesList"></div>
            </div>

            <button class="btn btn-primary" onclick="openPrizeModal()">â• æ–°å¢çé …</button>
        </div>

        <!-- å“¡å·¥ç®¡ç† -->
        <div id="employees" class="tab-content">
            <div class="section-title">ğŸ‘¥ å“¡å·¥ç®¡ç†</div>
            
            <div class="grid-3">
                <button class="btn btn-primary" onclick="openEmployeeModal()">â• æ–°å¢å“¡å·¥</button>
                <div class="file-upload">
                    <input type="file" id="csvFile" accept=".csv" onchange="importCSV()">
                    <label for="csvFile" class="file-upload-label">ğŸ“ åŒ¯å…¥CSV</label>
                </div>
                <button class="btn btn-info" onclick="exportCSV()">ğŸ’¾ åŒ¯å‡ºCSV</button>
            </div>

            <table class="employee-table" id="employeesTable">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>éƒ¨é–€</th>
                        <th>å¹´è³‡</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- æŠ½çè¦å‰‡ -->
        <div id="rules" class="tab-content">
            <div class="section-title">ğŸ“‹ æŠ½çè¦å‰‡ç®¡ç†</div>
            
            <!-- å¹´è³‡é™åˆ¶ -->
            <div class="rules-section">
                <h3>ğŸ¯ çé …å¹´è³‡è¦æ±‚</h3>
                <div id="yearRequirements"></div>
            </div>

            <!-- éƒ¨é–€é…é¡ -->
            <div class="rules-section">
                <h3>ğŸ¢ éƒ¨é–€é…é¡ç®¡ç†</h3>
                <div id="departmentQuotas"></div>
                <button class="btn btn-primary" onclick="calculateOptimalQuota()">ğŸ§® æ™ºèƒ½é…é¡è¨ˆç®—</button>
            </div>

            <!-- å€‹äººé™åˆ¶ -->
            <div class="rules-section">
                <h3>ğŸ‘¤ å€‹äººçé …é™åˆ¶</h3>
                <div id="personalRestrictions"></div>
                <button class="btn btn-primary" onclick="openRestrictionModal()">â• æ–°å¢å€‹äººé™åˆ¶</button>
            </div>

            <!-- åŠ ç¢¼çè¨­å®š -->
            <div class="bonus-settings">
                <h3>ğŸ åŠ ç¢¼çè¨­å®šï¼ˆä¿®å¾©ç‰ˆï¼‰</h3>
                <div class="grid-2">
                    <div class="input-group">
                        <label>å¹´è³‡è¦æ±‚ï¼ˆå¹´ï¼‰</label>
                        <input type="number" id="bonusYearReq" min="0" value="3">
                    </div>
                    <div class="input-group">
                        <label>çé …åé¡</label>
                        <input type="number" id="bonusQuantity" min="1" value="2">
                    </div>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="excludeTopPrizes" checked>
                    <label for="excludeTopPrizes">æ’é™¤å‰ N çå¾—ä¸»</label>
                </div>
                <div class="range-input">
                    <label>å‰</label>
                    <input type="range" id="topPrizeCount" min="1" max="10" value="3">
                    <span id="topPrizeValue">3</span>
                    <label>çå¾—ä¸»ï¼ˆæŒ‰Orderæ’åºï¼Œæ•¸å­—å¤§çš„æ˜¯å¤§çï¼‰</label>
                </div>
                <div class="rule-item">
                    ğŸ’¡ åˆæ ¼äººæ•¸é è¦½: <span id="bonusEligiblePreview">è¨ˆç®—ä¸­...</span>
                </div>
                <button class="btn btn-success" onclick="saveBonusSettings()">ğŸ’¾ ä¿å­˜åŠ ç¢¼çè¨­å®š</button>
            </div>
        </div>

        <!-- ä¸­çè¨˜éŒ„ -->
        <div id="winners" class="tab-content">
            <div class="section-title">ğŸ‰ å³æ™‚ä¸­çè¨˜éŒ„</div>
            
            <div class="grid-2">
                <div>
                    <h4>æŒ‰çé …åˆ†é¡</h4>
                    <div id="winnersByPrize"></div>
                </div>
                <div>
                    <h4>éƒ¨é–€å¾—ççµ±è¨ˆ</h4>
                    <div id="winnersByDepartment"></div>
                </div>
            </div>

            <div class="winners-list" id="winnersList">
                <h4>å®Œæ•´æ­·å²åˆ—è¡¨</h4>
                <div id="allWinners"></div>
            </div>
        </div>

        <!-- ç³»çµ±è¨­å®š -->
        <div id="settings" class="tab-content">
            <div class="section-title">âš™ï¸ ç³»çµ±è¨­å®š</div>
            
            <div class="grid-2">
                <div>
                    <h4>ğŸ“¤ åŒ¯å‡ºè¨­å®š</h4>
                    <button class="btn btn-success" onclick="exportSettings()">ğŸ’¾ åŒ¯å‡ºå®Œæ•´è¨­å®šæª”</button>
                    <p>åŒ¯å‡ºå“¡å·¥+çé …+è¦å‰‡çš„å®Œæ•´è¨­å®š</p>
                    
                    <h4 style="margin-top: 20px;">ğŸ“¥ åŒ¯å…¥è¨­å®š</h4>
                    <div class="file-upload">
                        <input type="file" id="settingsFile" accept=".json" onchange="importSettings()">
                        <label for="settingsFile" class="file-upload-label">ğŸ“ å¾è¨­å®šæª”é‚„åŸè³‡æ–™</label>
                    </div>
                </div>
                <div>
                    <h4>ğŸ”„ åŒæ­¥ç‹€æ…‹</h4>
                    <button class="btn btn-primary" onclick="forcSync()">â˜ï¸ å¼·åˆ¶åŒæ­¥åˆ°é›²ç«¯</button>
                    <button class="btn btn-warning" onclick="resetLottery()">ğŸ”„ é‡è¨­æŠ½çç‹€æ…‹</button>
                    <button class="btn btn-danger" onclick="clearTestRecords()">ğŸ§¹ æ¸…ç©ºæ¸¬è©¦è¨˜éŒ„</button>
                    <button class="btn btn-info" onclick="exportSystemReport()">ğŸ“Š åŒ¯å‡ºç³»çµ±å ±å‘Š</button>
                </div>
            </div>

            <!-- æ¸…ç©ºæ¸¬è©¦è¨˜éŒ„èªªæ˜ -->
            <div class="clear-test-section">
                <h4>ğŸ§¹ æ¸…ç©ºæ¸¬è©¦è¨˜éŒ„èªªæ˜</h4>
                <div class="grid-2">
                    <div>
                        <p><strong>æ¸…ç©ºå…§å®¹ï¼š</strong></p>
                        <ul>
                            <li>âœ… æ‰€æœ‰ä¸­çè¨˜éŒ„</li>
                            <li>âœ… é‡è¨­çé …å·²æŠ½å‡ºæ•¸é‡ç‚º0</li>
                            <li>âœ… é‡è¨­åŠ ç¢¼çå•Ÿå‹•ç‹€æ…‹</li>
                            <li>âœ… é‡è¨­æŠ½çç‹€æ…‹ç‚ºwaiting</li>
                        </ul>
                    </div>
                    <div>
                        <p><strong>ä¿ç•™å…§å®¹ï¼š</strong></p>
                        <ul>
                            <li>ğŸ”’ å“¡å·¥è³‡æ–™</li>
                            <li>ğŸ”’ çé …è¨­å®š</li>
                            <li>ğŸ”’ æŠ½çè¦å‰‡è¨­å®š</li>
                            <li>ğŸ”’ çé …é †åºè¨­å®š</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- çé …è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="prizeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePrizeModal()">&times;</span>
            <h2 id="prizeModalTitle">æ–°å¢çé …</h2>
            <div class="input-group">
                <label>æŠ½çé †åº <small>(æ•¸å­—è¶Šå°è¶Šå…ˆæŠ½ï¼Œä¾‹ï¼š1=æœ€å…ˆæŠ½å…«çï¼Œ8=æœ€å¾ŒæŠ½é ­ç)</small></label>
                <input type="number" id="prizeOrder" min="1" value="1">
            </div>
            <div class="input-group">
                <label>çé …åç¨±</label>
                <input type="text" id="prizeName" placeholder="ä¾‹ï¼šé ­çã€äºŒçã€ä¸‰çã€å…«ç">
            </div>
            <div class="input-group">
                <label>çé …å…§å®¹ <small>(çå“è©³ç´°æè¿°)</small></label>
                <input type="text" id="prizeContent" placeholder="ä¾‹ï¼š20000å…ƒã€iPhone 15ã€è³¼ç‰©åˆ¸">
            </div>
            <div class="input-group">
                <label>åé¡æ•¸é‡</label>
                <input type="number" id="prizeQuantity" min="1" value="1">
            </div>
            <button class="btn btn-primary" onclick="savePrize()">ğŸ’¾ ä¿å­˜</button>
            <button class="btn" onclick="closePrizeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- å“¡å·¥è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEmployeeModal()">&times;</span>
            <h2 id="employeeModalTitle">æ–°å¢å“¡å·¥</h2>
            <div class="input-group">
                <label>å§“å</label>
                <input type="text" id="employeeName" placeholder="è¼¸å…¥å§“å">
            </div>
            <div class="input-group">
                <label>éƒ¨é–€</label>
                <input type="text" id="employeeDepartment" placeholder="è¼¸å…¥éƒ¨é–€åç¨±">
            </div>
            <div class="input-group">
                <label>å¹´è³‡ï¼ˆå¹´ï¼‰</label>
                <input type="number" id="employeeYears" min="0" value="0">
            </div>
            <button class="btn btn-primary" onclick="saveEmployee()">ğŸ’¾ ä¿å­˜</button>
            <button class="btn" onclick="closeEmployeeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- å€‹äººé™åˆ¶æ¨¡æ…‹æ¡† -->
    <div id="restrictionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRestrictionModal()">&times;</span>
            <h2>æ–°å¢å€‹äººé™åˆ¶</h2>
            <div class="input-group">
                <label>é¸æ“‡å“¡å·¥</label>
                <select id="restrictionEmployee"></select>
            </div>
            <div class="input-group">
                <label>æ’é™¤çé …</label>
                <div id="restrictionPrizes"></div>
            </div>
            <button class="btn btn-primary" onclick="saveRestriction()">ğŸ’¾ ä¿å­˜</button>
            <button class="btn" onclick="closeRestrictionModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let employees = JSON.parse(localStorage.getItem('employees') || '[]');
        let prizes = JSON.parse(localStorage.getItem('prizes') || '[]');
        let winners = JSON.parse(localStorage.getItem('winners') || '[]');
        let rules = JSON.parse(localStorage.getItem('rules') || '{"yearRequirements": {}, "departmentQuotas": {}, "personalRestrictions": {}}');
        let bonusSettings = JSON.parse(localStorage.getItem('bonusSettings') || '{"yearRequirement": 3, "excludeTopPrizes": {"enabled": true, "topCount": 3}, "quantity": 2, "activated": false}');
        let lotteryState = JSON.parse(localStorage.getItem('lotteryState') || '{"status": "waiting", "currentPrize": null, "currentWinner": null}');
        let editingPrizeId = null;
        let editingEmployeeId = null;

        // ===== æ ¸å¿ƒåŠŸèƒ½ï¼šIDæ¨™æº–åŒ–è™•ç†å‡½æ•¸ =====
        function normalizeId(id) {
            if (id === 'bonus') return 'bonus';
            return parseInt(id);
        }

        function findPrizeById(prizeId) {
            const normalizedId = normalizeId(prizeId);
            if (normalizedId === 'bonus') return null;
            return prizes.find(p => normalizeId(p.id) === normalizedId);
        }

        function getPrizeName(prizeId) {
            if (prizeId === 'bonus') return 'åŠ ç¢¼ç';
            const prize = findPrizeById(prizeId);
            return prize ? prize.name : `çé …ID:${prizeId}`;
        }

        function getPrizeDisplayName(prizeId) {
            if (prizeId === 'bonus') return 'åŠ ç¢¼ç';
            const prize = findPrizeById(prizeId);
            if (prize) {
                return prize.content ? `${prize.name} ${prize.content}` : prize.name;
            }
            return `çé …ID:${prizeId}`;
        }

        // ===== ä¿®å¾©æ ¸å¿ƒï¼šæ ¹æ“šOrderåˆ¤æ–·å‰Nççš„å‡½æ•¸ =====
        function getTopPrizes(topCount) {
            return prizes
                .sort((a, b) => b.order - a.order)  // æŒ‰orderé™åºæ’åˆ—ï¼ˆæ•¸å­—å¤§çš„æ˜¯å¤§çï¼‰
                .slice(0, topCount);                // å–å‰Nå€‹
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¯ æŠ½çç³»çµ±ç®¡ç†å¾Œå° - HTMLä¿®å¾©ç‰ˆåˆå§‹åŒ–é–‹å§‹');
            initializeData();
            updateStats();
            renderPrizes();
            renderEmployees();
            renderRules();
            renderWinners();
            updateEngineStatus();
            setupBonusControls();
            setupEventListeners();
            console.log('âœ¨ ä¿®å¾©å®Œæˆï¼šHTMLçµæ§‹ã€Orderé‚è¼¯ã€Contentæ¬„ä½ã€å‰Nçåˆ¤æ–·');
        });

        // åˆå§‹åŒ–é è¨­è³‡æ–™
        function initializeData() {
            if (employees.length === 0) {
                employees = [
                    {id: 1, name: 'å¼µå°æ˜', department: 'ITéƒ¨', years: 5, status: 'active'},
                    {id: 2, name: 'æå°è¯', department: 'æ¥­å‹™éƒ¨', years: 3, status: 'active'},
                    {id: 3, name: 'ç‹å°ç¾', department: 'ITéƒ¨', years: 7, status: 'active'},
                    {id: 4, name: 'é™³å°å¼·', department: 'è²¡å‹™éƒ¨', years: 2, status: 'active'},
                    {id: 5, name: 'æ—å°èŠ³', department: 'TGéƒ¨', years: 4, status: 'active'},
                    {id: 6, name: 'é»ƒå°æ–‡', department: 'EGéƒ¨', years: 6, status: 'active'}
                ];
            }
            
            if (prizes.length === 0) {
                prizes = [
                    {id: 1, order: 1, name: 'å…«ç', content: '3600å…ƒ', quantity: 5, drawn: 0, yearRequirement: 0},
                    {id: 2, order: 2, name: 'ä¸ƒç', content: '5000å…ƒ', quantity: 3, drawn: 0, yearRequirement: 0},
                    {id: 3, order: 3, name: 'å…­ç', content: '6000å…ƒ', quantity: 3, drawn: 0, yearRequirement: 1},
                    {id: 4, order: 4, name: 'äº”ç', content: '8000å…ƒ', quantity: 2, drawn: 0, yearRequirement: 1},
                    {id: 5, order: 5, name: 'å››ç', content: '10000å…ƒ', quantity: 2, drawn: 0, yearRequirement: 2},
                    {id: 6, order: 6, name: 'ä¸‰ç', content: '12000å…ƒ', quantity: 1, drawn: 0, yearRequirement: 3},
                    {id: 7, order: 7, name: 'äºŒç', content: '15000å…ƒ', quantity: 1, drawn: 0, yearRequirement: 3},
                    {id: 8, order: 8, name: 'é ­ç', content: '20000å…ƒ', quantity: 1, drawn: 0, yearRequirement: 5}
                ];
            }
            saveData();
        }

        function setupEventListeners() {
            window.addEventListener('storage', function(e) {
                if (e.key === 'lotteryCommand') {
                    const command = JSON.parse(e.newValue);
                    handleLotteryCommand(command);
                }
            });
            
            window.addEventListener('storage', function(e) {
                if (e.key === 'lotteryEvent') {
                    const event = JSON.parse(e.newValue);
                    handleLotteryEvent(event);
                }
            });
        }

        function handleLotteryCommand(command) {
            switch(command.type) {
                case 'START_LOTTERY':
                    handleLotteryStart(command.prizeId);
                    break;
                case 'STOP_LOTTERY':
                    handleLotteryStop();
                    break;
                case 'FORCE_STOP':
                    forceLotteryStop();
                    break;
            }
        }

        function handleLotteryEvent(event) {
            switch(event.type) {
                case 'START_LOTTERY':
                    handleLotteryStart(event.prizeId);
                    break;
                case 'STOP_LOTTERY':
                    handleLotteryStop();
                    break;
                case 'FORCE_STOP':
                case 'EMERGENCY_RESET':
                    forceLotteryStop();
                    break;
            }
        }

        function saveData() {
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('prizes', JSON.stringify(prizes));
            localStorage.setItem('winners', JSON.stringify(winners));
            localStorage.setItem('rules', JSON.stringify(rules));
            localStorage.setItem('bonusSettings', JSON.stringify(bonusSettings));
            localStorage.setItem('lotteryState', JSON.stringify(lotteryState));
        }

        function updateStats() {
            document.getElementById('totalEmployees').textContent = employees.filter(e => e.status === 'active').length;
            document.getElementById('totalPrizes').textContent = prizes.length + (bonusSettings.activated ? 1 : 0);
            document.getElementById('totalWinners').textContent = winners.length;
            document.getElementById('totalQuota').textContent = prizes.reduce((sum, p) => sum + p.quantity, 0) + (bonusSettings.activated ? bonusSettings.quantity : 0);
        }

        function updateEngineStatus() {
            const statusMap = {
                waiting: 'ç­‰å¾…ä¸­',
                rolling: 'æŠ½çä¸­',
                showing: 'é¡¯ç¤ºçµæœ'
            };
            
            document.getElementById('engineStatus').textContent = statusMap[lotteryState.status] || 'ç­‰å¾…ä¸­';
            document.getElementById('currentPrize').textContent = lotteryState.currentPrize ? getPrizeDisplayName(lotteryState.currentPrize) : 'ç„¡';
            
            if (lotteryState.currentPrize) {
                const eligible = getEligibleEmployees(lotteryState.currentPrize);
                document.getElementById('eligibleCount').textContent = eligible.length;
            } else {
                document.getElementById('eligibleCount').textContent = '0';
            }
            
            document.getElementById('bonusStatus').textContent = bonusSettings.activated ? 'å·²å•Ÿå‹•' : 'æœªå•Ÿå‹•';
            const activateBtn = document.getElementById('activateBonusBtn');
            if (bonusSettings.activated) {
                activateBtn.textContent = 'ğŸ›‘ åœç”¨åŠ ç¢¼ç';
                activateBtn.className = 'btn btn-danger';
            } else {
                activateBtn.textContent = 'ğŸš€ å•Ÿå‹•åŠ ç¢¼ç';
                activateBtn.className = 'btn btn-warning';
            }
        }

        // ===== ä¿®å¾©æ ¸å¿ƒï¼šç²å–ç¬¦åˆæ¢ä»¶çš„å“¡å·¥ï¼ˆä½¿ç”¨Orderåˆ¤æ–·å‰Nçï¼‰ =====
        function getEligibleEmployees(prizeId) {
            const activeEmployees = employees.filter(emp => emp.status === 'active');
            
            if (prizeId === 'bonus') {
                console.log('=== åŠ ç¢¼çç¯©é¸é–‹å§‹ï¼ˆä¿®å¾©ç‰ˆï¼‰ ===');
                console.log('å¹´è³‡è¦æ±‚:', bonusSettings.yearRequirement);
                console.log('æ’é™¤å‰Nçè¨­å®š:', bonusSettings.excludeTopPrizes);
                
                return activeEmployees.filter(employee => {
                    console.log(`æª¢æŸ¥å“¡å·¥: ${employee.name} (ID: ${employee.id})`);
                    
                    if (employee.years < bonusSettings.yearRequirement) {
                        console.log(`  âŒ å¹´è³‡ä¸è¶³: ${employee.years} < ${bonusSettings.yearRequirement}`);
                        return false;
                    }
                    console.log(`  âœ… å¹´è³‡ç¬¦åˆ: ${employee.years} >= ${bonusSettings.yearRequirement}`);
                    
                    const hasWonBonus = winners.some(w => w.prizeId === 'bonus' && normalizeId(w.employeeId) === normalizeId(employee.id));
                    if (hasWonBonus) {
                        console.log(`  âŒ å·²ç²å¾—åŠ ç¢¼ç`);
                        return false;
                    }
                    console.log(`  âœ… æœªç²å¾—åŠ ç¢¼ç`);
                    
                    const restrictions = rules.personalRestrictions[employee.id] || [];
                    if (restrictions.includes('bonus')) {
                        console.log(`  âŒ å€‹äººé™åˆ¶æ’é™¤åŠ ç¢¼ç`);
                        return false;
                    }
                    console.log(`  âœ… ç„¡å€‹äººé™åˆ¶`);
                    
                    if (bonusSettings.excludeTopPrizes.enabled) {
                        console.log(`  ğŸ” æª¢æŸ¥æ˜¯å¦ç‚ºå‰${bonusSettings.excludeTopPrizes.topCount}çå¾—ä¸»`);
                        
                        const topPrizes = getTopPrizes(bonusSettings.excludeTopPrizes.topCount);
                        console.log(`  å‰${bonusSettings.excludeTopPrizes.topCount}çé …ï¼ˆæŒ‰Orderæ’åºï¼‰:`, topPrizes.map(p => `${p.name}(ID:${p.id}, Order:${p.order})`));
                        
                        const employeeWinnings = winners.filter(w => normalizeId(w.employeeId) === normalizeId(employee.id));
                        console.log(`  ${employee.name}çš„ç²çè¨˜éŒ„:`, employeeWinnings);
                        
                        const isTopPrizeWinner = employeeWinnings.some(w => {
                            if (w.prizeId === 'bonus') {
                                console.log(`    è·³éåŠ ç¢¼çè¨˜éŒ„`);
                                return false;
                            }
                            
                            const wonPrize = findPrizeById(w.prizeId);
                            if (!wonPrize) {
                                console.log(`    æ‰¾ä¸åˆ°çé …ID: ${w.prizeId}`);
                                return false;
                            }
                            
                            console.log(`    æª¢æŸ¥ç²çè¨˜éŒ„: ${wonPrize.name} (ID:${wonPrize.id}, Order:${wonPrize.order})`);
                            
                            const isTopPrize = topPrizes.some(tp => normalizeId(tp.id) === normalizeId(wonPrize.id));
                            
                            if (isTopPrize) {
                                console.log(`    âŒ ç™¼ç¾å‰${bonusSettings.excludeTopPrizes.topCount}çå¾—ä¸»: ${wonPrize.name} (Order:${wonPrize.order})`);
                                return true;
                            }
                            
                            return false;
                        });
                        
                        if (isTopPrizeWinner) {
                            console.log(`  âŒ æ˜¯å‰${bonusSettings.excludeTopPrizes.topCount}çå¾—ä¸»ï¼Œæ’é™¤`);
                            return false;
                        }
                        console.log(`  âœ… ä¸æ˜¯å‰${bonusSettings.excludeTopPrizes.topCount}çå¾—ä¸»ï¼Œå¯åƒèˆ‡`);
                    }
                    
                    console.log(`  ğŸ‰ ${employee.name} ç¬¦åˆåŠ ç¢¼çæ¢ä»¶`);
                    return true;
                });
            } else {
                const prize = findPrizeById(prizeId);
                if (!prize) return [];
                
                const basicEligible = activeEmployees.filter(employee => {
                    if (employee.years < (prize.yearRequirement || 0)) return false;
                    
                    const restrictions = rules.personalRestrictions[employee.id] || [];
                    const prizeIdStr = prizeId.toString();
                    const prizeIdNum = normalizeId(prizeId);
                    if (restrictions.includes(prizeIdStr) || restrictions.includes(prizeIdNum)) return false;
                    
                    const hasWon = winners.some(w => normalizeId(w.employeeId) === normalizeId(employee.id));
                    if (hasWon) return false;
                    
                    return true;
                });
                
                return applyDepartmentQuota(basicEligible);
            }
        }

        function applyDepartmentQuota(eligibleEmployees) {
            const departmentQuotas = rules.departmentQuotas || {};
            const departments = Object.keys(departmentQuotas);
            
            if (departments.length === 0) {
                return eligibleEmployees;
            }
            
            const departmentWinCounts = {};
            departments.forEach(dept => {
                departmentWinCounts[dept] = winners.filter(winner => {
                    const employee = employees.find(e => normalizeId(e.id) === normalizeId(winner.employeeId));
                    return employee && employee.department === dept;
                }).length;
            });
            
            const weightedEmployees = [];
            
            eligibleEmployees.forEach(employee => {
                const dept = employee.department;
                const targetQuota = departmentQuotas[dept] || 0;
                const currentWins = departmentWinCounts[dept] || 0;
                
                let weight = 1;
                
                if (targetQuota > 0) {
                    if (currentWins < targetQuota) {
                        const deficit = targetQuota - currentWins;
                        weight = 1 + (deficit * 2);
                    } else {
                        weight = 0.1;
                    }
                }
                
                const repeatCount = Math.max(1, Math.round(weight * 10));
                for (let i = 0; i < repeatCount; i++) {
                    weightedEmployees.push(employee);
                }
            });
            
            return weightedEmployees;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function renderPrizes() {
            const container = document.getElementById('prizesList');
            const sortedPrizes = [...prizes].sort((a, b) => a.order - b.order);
            
            container.innerHTML = sortedPrizes.map(prize => `
                <div class="prize-item" data-id="${prize.id}">
                    <div class="prize-order">${prize.order}</div>
                    <div class="prize-name">${prize.name}</div>
                    <div class="prize-content">${prize.content || ''}</div>
                    <div>${prize.quantity}</div>
                    <div>${prize.drawn}</div>
                    <div>${prize.quantity - prize.drawn}</div>
                    <div>
                        <button class="btn btn-info" onclick="editPrize(${prize.id})">âœï¸</button>
                        <button class="btn btn-danger" onclick="deletePrize(${prize.id})">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');

            if (bonusSettings.activated) {
                const bonusWinners = winners.filter(w => w.prizeId === 'bonus').length;
                container.innerHTML += `
                    <div class="prize-item bonus-prize">
                        <div style="text-align: center;">ğŸ</div>
                        <div class="prize-name">åŠ ç¢¼ç</div>
                        <div class="prize-content">ç‰¹åˆ¥çé …</div>
                        <div>${bonusSettings.quantity}</div>
                        <div>${bonusWinners}</div>
                        <div>${bonusSettings.quantity - bonusWinners}</div>
                        <div>
                            <button class="btn btn-info" onclick="openBonusSettings()">âš™ï¸</button>
                        </div>
                    </div>
                `;
            }
        }

        function renderEmployees() {
            const tbody = document.querySelector('#employeesTable tbody');
            tbody.innerHTML = employees.map(emp => `
                <tr>
                    <td>${emp.name}</td>
                    <td>${emp.department}</td>
                    <td>${emp.years}å¹´</td>
                    <td>
                        <span class="status ${emp.status}">${emp.status === 'active' ? 'åœ¨è·' : 'é›¢è·'}</span>
                    </td>
                    <td>
                        <button class="btn btn-info" onclick="editEmployee(${emp.id})">âœï¸</button>
                        <button class="btn btn-danger" onclick="deleteEmployee(${emp.id})">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderRules() {
            renderYearRequirements();
            renderDepartmentQuotas();
            renderPersonalRestrictions();
        }

        function renderYearRequirements() {
            const container = document.getElementById('yearRequirements');
            const sortedPrizes = [...prizes].sort((a, b) => a.order - b.order);
            container.innerHTML = sortedPrizes.map(prize => `
                <div class="rule-item">
                    <span>${prize.name} ${prize.content || ''}:</span>
                    <input type="number" min="0" value="${prize.yearRequirement || 0}" 
                           onchange="updateYearRequirement(${prize.id}, this.value)">
                    <span>å¹´ä»¥ä¸Š</span>
                    <span>âš™ï¸</span>
                </div>
            `).join('');
        }

        function updateYearRequirement(prizeId, years) {
            const prize = findPrizeById(prizeId);
            if (prize) {
                prize.yearRequirement = parseInt(years) || 0;
                saveData();
                updateBonusEligiblePreview();
                showNotification('å¹´è³‡è¦æ±‚å·²æ›´æ–°');
            }
        }

        function renderDepartmentQuotas() {
            const departments = [...new Set(employees.filter(e => e.status === 'active').map(e => e.department))];
            const container = document.getElementById('departmentQuotas');
            
            container.innerHTML = departments.map(dept => {
                const deptEmployees = employees.filter(e => e.department === dept && e.status === 'active');
                const eligibleCount = deptEmployees.length;
                const currentQuota = rules.departmentQuotas[dept] || 0;
                const currentWins = winners.filter(winner => {
                    const employee = employees.find(e => normalizeId(e.id) === normalizeId(winner.employeeId));
                    return employee && employee.department === dept;
                }).length;
                const percentage = eligibleCount > 0 ? Math.round(currentQuota / eligibleCount * 100) : 0;
                
                return `
                    <div class="department-quota">
                        <div>${dept} (ç¸½å“¡å·¥: ${deptEmployees.length}äºº, ç¬¦åˆæ¢ä»¶: ${eligibleCount}äºº)</div>
                        <div>ç›®æ¨™å¾—çæ•¸: 
                            <input type="number" min="0" max="${eligibleCount}" value="${currentQuota}"
                                   onchange="updateDepartmentQuota('${dept}', this.value)">
                            äºº | ç›®å‰å·²å¾—ç: ${currentWins}äºº
                        </div>
                        <div>(ç›®æ¨™${percentage}% | é€²åº¦: ${currentWins}/${currentQuota})</div>
                        <div class="quota-info">
                            ${currentWins >= currentQuota ? 'âœ… å·²é”æˆç›®æ¨™' : 'â³ æœªé”æˆç›®æ¨™ï¼ŒæŠ½çæ™‚æœƒæé«˜è©²éƒ¨é–€å“¡å·¥çš„ä¸­çæ©Ÿç‡'}
                        </div>
                    </div>
                `;
            }).join('');
            
            const totalQuota = Object.values(rules.departmentQuotas).reduce((sum, q) => sum + q, 0);
            const totalPrizeQuota = prizes.reduce((sum, p) => sum + p.quantity, 0);
            const totalCurrentWins = winners.length;
            
            container.innerHTML += `
                <div class="rule-item">
                    ğŸ’¡ éƒ¨é–€é…é¡èªªæ˜: è¨­å®šå„éƒ¨é–€æœŸæœ›çš„å¾—çäººæ•¸ï¼Œç³»çµ±æœƒè‡ªå‹•èª¿æ•´æŠ½çæ©Ÿç‡
                </div>
                <div class="rule-item">
                    ğŸ“Š æ•´é«”é€²åº¦: å·²è¨­å®š${totalQuota}äººç›®æ¨™ï¼Œå¯¦éš›å¾—ç${totalCurrentWins}äººï¼Œç¸½åé¡${totalPrizeQuota}äºº
                </div>
            `;
        }

        function updateDepartmentQuota(department, quota) {
            rules.departmentQuotas[department] = parseInt(quota) || 0;
            saveData();
            renderDepartmentQuotas();
            showNotification(`${department}é…é¡å·²æ›´æ–°`);
        }

        function renderPersonalRestrictions() {
            const container = document.getElementById('personalRestrictions');
            const restrictions = rules.personalRestrictions || {};
            
            container.innerHTML = Object.entries(restrictions).map(([empId, restrictedItems]) => {
                const employee = employees.find(e => normalizeId(e.id) === normalizeId(empId));
                const restrictedNames = restrictedItems.map(item => {
                    if (item === 'bonus') {
                        return 'åŠ ç¢¼ç';
                    } else {
                        return getPrizeName(item);
                    }
                }).filter(name => !name.startsWith('çé …ID:'));
                
                return employee ? `
                    <div class="rule-item">
                        <span>${employee.name}</span>
                        <span>âŒ ${restrictedNames.join('ã€')}</span>
                        <button class="btn btn-danger" onclick="removeRestriction(${empId})">ç§»é™¤</button>
                    </div>
                ` : '';
            }).join('');
        }

        function removeRestriction(empId) {
            delete rules.personalRestrictions[normalizeId(empId)];
            saveData();
            renderPersonalRestrictions();
            showNotification('å€‹äººé™åˆ¶å·²ç§»é™¤');
        }

        function setupBonusControls() {
            document.getElementById('bonusYearReq').addEventListener('change', function() {
                bonusSettings.yearRequirement = parseInt(this.value) || 0;
                saveData();
                updateBonusEligiblePreview();
            });
            
            document.getElementById('bonusQuantity').addEventListener('change', function() {
                bonusSettings.quantity = parseInt(this.value) || 1;
                saveData();
                updateBonusEligiblePreview();
            });
            
            document.getElementById('excludeTopPrizes').addEventListener('change', function() {
                bonusSettings.excludeTopPrizes.enabled = this.checked;
                saveData();
                updateBonusEligiblePreview();
            });
            
            const topPrizeRange = document.getElementById('topPrizeCount');
            const topPrizeValue = document.getElementById('topPrizeValue');
            topPrizeRange.addEventListener('input', function() {
                topPrizeValue.textContent = this.value;
                bonusSettings.excludeTopPrizes.topCount = parseInt(this.value);
                saveData();
                updateBonusEligiblePreview();
            });
            
            document.getElementById('bonusYearReq').value = bonusSettings.yearRequirement;
            document.getElementById('bonusQuantity').value = bonusSettings.quantity;
            document.getElementById('excludeTopPrizes').checked = bonusSettings.excludeTopPrizes.enabled;
            document.getElementById('topPrizeCount').value = bonusSettings.excludeTopPrizes.topCount;
            document.getElementById('topPrizeValue').textContent = bonusSettings.excludeTopPrizes.topCount;
            
            updateBonusEligiblePreview();
        }

        function updateBonusEligiblePreview() {
            const eligibleEmployees = getEligibleEmployees('bonus');
            document.getElementById('bonusEligiblePreview').textContent = `${eligibleEmployees.length}äºº`;
        }

        function saveBonusSettings() {
            bonusSettings.yearRequirement = parseInt(document.getElementById('bonusYearReq').value) || 0;
            bonusSettings.quantity = parseInt(document.getElementById('bonusQuantity').value) || 1;
            bonusSettings.excludeTopPrizes.enabled = document.getElementById('excludeTopPrizes').checked;
            bonusSettings.excludeTopPrizes.topCount = parseInt(document.getElementById('topPrizeCount').value) || 3;
            
            saveData();
            updateBonusEligiblePreview();
            showNotification('åŠ ç¢¼çè¨­å®šå·²ä¿å­˜');
        }

        function renderWinners() {
            renderWinnersByPrize();
            renderWinnersByDepartment();
            renderAllWinners();
        }

        function renderWinnersByPrize() {
            const container = document.getElementById('winnersByPrize');
            const grouped = {};
            
            winners.forEach(winner => {
                const prizeName = getPrizeDisplayName(winner.prizeId);
                let prizeOrder = 999;
                
                if (winner.prizeId === 'bonus') {
                    prizeOrder = 1000;
                } else {
                    const prize = findPrizeById(winner.prizeId);
                    if (prize) {
                        prizeOrder = prize.order;
                    }
                }
                
                const employee = employees.find(e => normalizeId(e.id) === normalizeId(winner.employeeId));
                if (employee) {
                    if (!grouped[prizeName]) {
                        grouped[prizeName] = {
                            names: [],
                            order: prizeOrder
                        };
                    }
                    grouped[prizeName].names.push(employee.name);
                }
            });
            
            const sortedGroups = Object.entries(grouped).sort((a, b) => a[1].order - b[1].order);
            
            container.innerHTML = sortedGroups.map(([prizeName, data]) => `
                <div class="winner-item">
                    <strong>${prizeName}:</strong>
                    <span>${data.names.join('ã€')}</span>
                </div>
            `).join('') || '<p>æš«ç„¡ä¸­çè¨˜éŒ„</p>';
        }

        function renderWinnersByDepartment() {
            const container = document.getElementById('winnersByDepartment');
            const grouped = {};
            
            winners.forEach(winner => {
                const employee = employees.find(e => normalizeId(e.id) === normalizeId(winner.employeeId));
                if (employee) {
                    if (!grouped[employee.department]) grouped[employee.department] = 0;
                    grouped[employee.department]++;
                }
            });
            
            container.innerHTML = Object.entries(grouped).map(([dept, count]) => {
                const total = employees.filter(e => e.department === dept && e.status === 'active').length;
                const percentage = total > 0 ? Math.round(count / total * 100) : 0;
                return `
                    <div class="winner-item">
                        <strong>${dept}:</strong>
                        <span>${count}/${total}äºº (${percentage}%)</span>
                    </div>
                `;
            }).join('') || '<p>æš«ç„¡çµ±è¨ˆè³‡æ–™</p>';
        }

        function renderAllWinners() {
            const container = document.getElementById('allWinners');
            
            if (winners.length === 0) {
                container.innerHTML = '<p>æš«ç„¡ä¸­çè¨˜éŒ„</p>';
                return;
            }
            
            const sortedWinners = [...winners].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            container.innerHTML = sortedWinners.map(winner => {
                const prizeName = getPrizeDisplayName(winner.prizeId);
                const employee = employees.find(e => normalizeId(e.id) === normalizeId(winner.employeeId));
                
                if (employee) {
                    return `
                        <div class="winner-item">
                            <div>
                                <strong>${employee.name}</strong> (${employee.department})
                                ç²å¾— <strong>${prizeName}</strong>
                            </div>
                            <small>${new Date(winner.timestamp).toLocaleString('zh-TW')}</small>
                        </div>
                    `;
                }
                return '';
            }).join('');
        }

        // çé …ç›¸é—œå‡½æ•¸
        function openPrizeModal(prizeId = null) {
            editingPrizeId = prizeId;
            const modal = document.getElementById('prizeModal');
            const title = document.getElementById('prizeModalTitle');
            
            if (prizeId) {
                const prize = findPrizeById(prizeId);
                if (prize) {
                    title.textContent = 'ç·¨è¼¯çé …';
                    document.getElementById('prizeOrder').value = prize.order || 1;
                    document.getElementById('prizeName').value = prize.name;
                    document.getElementById('prizeContent').value = prize.content || '';
                    document.getElementById('prizeQuantity').value = prize.quantity;
                }
            } else {
                title.textContent = 'æ–°å¢çé …';
                const maxOrder = prizes.length > 0 ? Math.max(...prizes.map(p => p.order)) : 0;
                document.getElementById('prizeOrder').value = maxOrder + 1;
                document.getElementById('prizeName').value = '';
                document.getElementById('prizeContent').value = '';
                document.getElementById('prizeQuantity').value = 1;
            }
            
            modal.style.display = 'block';
        }

        function closePrizeModal() {
            document.getElementById('prizeModal').style.display = 'none';
            editingPrizeId = null;
        }

        function savePrize() {
            const order = parseInt(document.getElementById('prizeOrder').value);
            const name = document.getElementById('prizeName').value.trim();
            const content = document.getElementById('prizeContent').value.trim();
            const quantity = parseInt(document.getElementById('prizeQuantity').value);
            
            if (!name) {
                showNotification('è«‹è¼¸å…¥çé …åç¨±', 'error');
                return;
            }
            
            if (!order || order < 1) {
                showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„æŠ½çé †åº', 'error');
                return;
            }
            
            const conflictPrize = prizes.find(p => p.order === order && (!editingPrizeId || p.id !== editingPrizeId));
            if (conflictPrize) {
                showNotification(`æŠ½çé †åº ${order} å·²è¢«ã€Œ${conflictPrize.name}ã€ä½¿ç”¨`, 'error');
                return;
            }
            
            if (editingPrizeId) {
                const prize = findPrizeById(editingPrizeId);
                if (prize) {
                    prize.order = order;
                    prize.name = name;
                    prize.content = content;
                    prize.quantity = quantity;
                }
            } else {
                const newId = Math.max(...prizes.map(p => p.id), 0) + 1;
                prizes.push({
                    id: newId,
                    order: order,
                    name: name,
                    content: content,
                    quantity: quantity,
                    drawn: 0,
                    yearRequirement: 0
                });
            }
            
            saveData();
            renderPrizes();
            renderRules();
            updateStats();
            closePrizeModal();
            showNotification('çé …å·²ä¿å­˜');
        }

        function editPrize(prizeId) {
            openPrizeModal(prizeId);
        }

        function deletePrize(prizeId) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤çé …å—ï¼Ÿ')) {
                prizes = prizes.filter(p => normalizeId(p.id) !== normalizeId(prizeId));
                saveData();
                renderPrizes();
                renderRules();
                updateStats();
                showNotification('çé …å·²åˆªé™¤');
            }
        }

        // å“¡å·¥ç›¸é—œå‡½æ•¸
        function openEmployeeModal(empId = null) {
            editingEmployeeId = empId;
            const modal = document.getElementById('employeeModal');
            const title = document.getElementById('employeeModalTitle');
            
            if (empId) {
                const emp = employees.find(e => normalizeId(e.id) === normalizeId(empId));
                if (emp) {
                    title.textContent = 'ç·¨è¼¯å“¡å·¥';
                    document.getElementById('employeeName').value = emp.name;
                    document.getElementById('employeeDepartment').value = emp.department;
                    document.getElementById('employeeYears').value = emp.years;
                }
            } else {
                title.textContent = 'æ–°å¢å“¡å·¥';
                document.getElementById('employeeName').value = '';
                document.getElementById('employeeDepartment').value = '';
                document.getElementById('employeeYears').value = 0;
            }
            
            modal.style.display = 'block';
        }

        function closeEmployeeModal() {
            document.getElementById('employeeModal').style.display = 'none';
            editingEmployeeId = null;
        }

        function saveEmployee() {
            const name = document.getElementById('employeeName').value.trim();
            const department = document.getElementById('employeeDepartment').value.trim();
            const years = parseInt(document.getElementById('employeeYears').value);
            
            if (!name || !department) {
                showNotification('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š', 'error');
                return;
            }
            
            if (editingEmployeeId) {
                const emp = employees.find(e => normalizeId(e.id) === normalizeId(editingEmployeeId));
                if (emp) {
                    emp.name = name;
                    emp.department = department;
                    emp.years = years;
                }
            } else {
                const newId = Math.max(...employees.map(e => e.id), 0) + 1;
                employees.push({
                    id: newId,
                    name: name,
                    department: department,
                    years: years,
                    status: 'active'
                });
            }
            
            saveData();
            renderEmployees();
            renderRules();
            updateStats();
            updateBonusEligiblePreview();
            closeEmployeeModal();
            showNotification('å“¡å·¥è³‡æ–™å·²ä¿å­˜');
        }

        function editEmployee(empId) {
            openEmployeeModal(empId);
        }

        function deleteEmployee(empId) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å“¡å·¥å—ï¼Ÿ')) {
                employees = employees.filter(e => normalizeId(e.id) !== normalizeId(empId));
                delete rules.personalRestrictions[normalizeId(empId)];
                saveData();
                renderEmployees();
                renderRules();
                updateStats();
                updateBonusEligiblePreview();
                showNotification('å“¡å·¥å·²åˆªé™¤');
            }
        }

        // CSVç›¸é—œ
        function importCSV() {
            const file = document.getElementById('csvFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length === 0) {
                        showNotification('CSVæª”æ¡ˆç‚ºç©º', 'error');
                        return;
                    }
                    
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    const requiredFields = ['name', 'department', 'years'];
                    const missingFields = requiredFields.filter(field => !headers.includes(field));
                    
                    if (missingFields.length > 0) {
                        showNotification(`CSVæ ¼å¼éŒ¯èª¤ï¼Œç¼ºå°‘æ¬„ä½: ${missingFields.join(', ')}`, 'error');
                        return;
                    }
                    
                    const nameIndex = headers.indexOf('name');
                    const deptIndex = headers.indexOf('department');
                    const yearsIndex = headers.indexOf('years');
                    
                    let importCount = 0;
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        if (values.length >= 3 && values[nameIndex] && values[deptIndex]) {
                            const newId = Math.max(...employees.map(e => e.id), 0) + 1 + importCount;
                            employees.push({
                                id: newId,
                                name: values[nameIndex],
                                department: values[deptIndex],
                                years: parseInt(values[yearsIndex]) || 0,
                                status: 'active'
                            });
                            importCount++;
                        }
                    }
                    
                    saveData();
                    renderEmployees();
                    renderRules();
                    updateStats();
                    updateBonusEligiblePreview();
                    showNotification(`æˆåŠŸåŒ¯å…¥ ${importCount} ä½å“¡å·¥`);
                } catch (error) {
                    showNotification('CSVè§£æå¤±æ•—', 'error');
                }
            };
            reader.readAsText(file);
        }

        function exportCSV() {
            const csvContent = [
                ['name', 'department', 'years', 'status'].join(','),
                ...employees.map(emp => [emp.name, emp.department, emp.years, emp.status].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `employees_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showNotification('å“¡å·¥è³‡æ–™å·²åŒ¯å‡º');
        }

        // å€‹äººé™åˆ¶ç›¸é—œ
        function openRestrictionModal() {
            const modal = document.getElementById('restrictionModal');
            
            const empSelect = document.getElementById('restrictionEmployee');
            empSelect.innerHTML = employees
                .filter(e => e.status === 'active')
                .map(emp => `<option value="${emp.id}">${emp.name} (${emp.department})</option>`)
                .join('');
            
            const prizesContainer = document.getElementById('restrictionPrizes');
            const sortedPrizes = [...prizes].sort((a, b) => a.order - b.order);
            let prizeOptions = sortedPrizes.map(prize => `
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" value="${prize.id}"> ${prize.name} ${prize.content || ''}
                </label>
            `).join('');
            
            if (bonusSettings.activated) {
                prizeOptions += `
                    <label style="display: block; margin-bottom: 10px;">
                        <input type="checkbox" value="bonus"> åŠ ç¢¼ç
                    </label>
                `;
            }
            
            prizesContainer.innerHTML = prizeOptions;
            modal.style.display = 'block';
        }

        function closeRestrictionModal() {
            document.getElementById('restrictionModal').style.display = 'none';
        }

        function saveRestriction() {
            const empId = normalizeId(document.getElementById('restrictionEmployee').value);
            const checkboxes = document.querySelectorAll('#restrictionPrizes input[type="checkbox"]:checked');
            const restrictedItems = Array.from(checkboxes).map(cb => {
                return cb.value === 'bonus' ? 'bonus' : normalizeId(cb.value);
            });
            
            if (restrictedItems.length === 0) {
                showNotification('è«‹é¸æ“‡è¦æ’é™¤çš„çé …', 'error');
                return;
            }
            
            if (!rules.personalRestrictions) rules.personalRestrictions = {};
            rules.personalRestrictions[empId] = restrictedItems;
            
            saveData();
            renderPersonalRestrictions();
            closeRestrictionModal();
            showNotification('å€‹äººé™åˆ¶å·²è¨­å®š');
        }

        // åŠ ç¢¼çç›¸é—œ
        function activateBonus() {
            if (bonusSettings.activated) {
                if (confirm('ç¢ºå®šè¦åœç”¨åŠ ç¢¼çå—ï¼Ÿ')) {
                    bonusSettings.activated = false;
                    saveData();
                    updateEngineStatus();
                    renderPrizes();
                    updateStats();
                    showNotification('åŠ ç¢¼çå·²åœç”¨', 'warning');
                }
            } else {
                if (confirm('ç¢ºå®šè¦å•Ÿå‹•åŠ ç¢¼çå—ï¼Ÿ')) {
                    bonusSettings.activated = true;
                    saveData();
                    updateEngineStatus();
                    renderPrizes();
                    updateStats();
                    showNotification('åŠ ç¢¼çå·²å•Ÿå‹•ï¼');
                }
            }
        }

        function openBonusSettings() {
            switchTab('rules');
            document.querySelector('.tab[onclick="switchTab(\'rules\')"]').click();
        }

        function calculateOptimalQuota() {
            const totalEmployees = employees.filter(e => e.status === 'active').length;
            const totalQuota = prizes.reduce((sum, p) => sum + p.quantity, 0);
            const departments = [...new Set(employees.filter(e => e.status === 'active').map(e => e.department))];
            
            departments.forEach(dept => {
                const deptCount = employees.filter(e => e.department === dept && e.status === 'active').length;
                const optimalQuota = Math.round(totalQuota * (deptCount / totalEmployees));
                rules.departmentQuotas[dept] = optimalQuota;
            });
            
            saveData();
            renderDepartmentQuotas();
            showNotification('æ™ºèƒ½é…é¡è¨ˆç®—å®Œæˆ');
        }

        // ç³»çµ±è¨­å®šç›¸é—œ
        function exportSettings() {
            const settings = {
                employees,
                prizes,
                winners,
                rules,
                bonusSettings,
                lotteryState,
                timestamp: new Date().toISOString(),
                version: '2.0-html-fixed'
            };
            
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `lottery-settings-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showNotification('ç³»çµ±è¨­å®šå·²åŒ¯å‡º');
        }

        function importSettings() {
            const file = document.getElementById('settingsFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    
                    if (confirm('åŒ¯å…¥è¨­å®šå°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                        if (settings.employees) employees = settings.employees;
                        if (settings.prizes) prizes = settings.prizes;
                        if (settings.winners) winners = settings.winners;
                        if (settings.rules) rules = settings.rules;
                        if (settings.bonusSettings) bonusSettings = settings.bonusSettings;
                        if (settings.lotteryState) lotteryState = settings.lotteryState;
                        
                        saveData();
                        location.reload();
                    }
                } catch (error) {
                    showNotification('è¨­å®šæª”æ ¼å¼éŒ¯èª¤', 'error');
                }
            };
            reader.readAsText(file);
        }

        function forcSync() {
            showNotification('æ­£åœ¨å¼·åˆ¶åŒæ­¥...', 'info');
            setTimeout(() => {
                showNotification('åŒæ­¥å®Œæˆ');
            }, 2000);
        }

        function resetLottery() {
            if (confirm('é€™å°‡é‡è¨­æŠ½çç‹€æ…‹ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                lotteryState = { status: 'waiting', currentPrize: null, currentWinner: null };
                saveData();
                updateEngineStatus();
                localStorage.setItem('lotteryEvent', JSON.stringify({
                    type: 'RESET_LOTTERY',
                    timestamp: new Date().toISOString()
                }));
                showNotification('æŠ½çç‹€æ…‹å·²é‡è¨­');
            }
        }

        function clearTestRecords() {
            if (confirm('é€™å°‡æ¸…ç©ºæ‰€æœ‰æ¸¬è©¦è¨˜éŒ„ä½†ä¿ç•™è¨­å®šï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                winners = [];
                prizes.forEach(prize => prize.drawn = 0);
                bonusSettings.activated = false;
                lotteryState = { status: 'waiting', currentPrize: null, currentWinner: null };
                
                saveData();
                updateStats();
                renderPrizes();
                renderWinners();
                updateEngineStatus();
                
                localStorage.setItem('testRecordsCleared', JSON.stringify({
                    timestamp: new Date().toISOString()
                }));
                
                showNotification('æ¸¬è©¦è¨˜éŒ„å·²æ¸…ç©ºï¼Œè¨­å®šå·²ä¿ç•™');
            }
        }

        function exportSystemReport() {
            const report = getSystemReport();
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `lottery-report-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showNotification('ç³»çµ±å ±å‘Šå·²åŒ¯å‡º');
        }

        function getSystemReport() {
            const totalEmployees = employees.filter(e => e.status === 'active').length;
            const totalPrizes = prizes.length;
            const totalWinners = winners.length;
            const completedPrizes = prizes.filter(p => p.drawn >= p.quantity).length;
            
            return {
                employees: {
                    total: totalEmployees,
                    byDepartment: employees.reduce((acc, emp) => {
                        if (emp.status === 'active') {
                            acc[emp.department] = (acc[emp.department] || 0) + 1;
                        }
                        return acc;
                    }, {})
                },
                prizes: {
                    total: totalPrizes,
                    completed: completedPrizes,
                    remaining: totalPrizes - completedPrizes,
                    totalQuota: prizes.reduce((sum, p) => sum + p.quantity, 0),
                    drawnQuota: prizes.reduce((sum, p) => sum + p.drawn, 0)
                },
                winners: {
                    total: totalWinners,
                    byPrize: winners.reduce((acc, winner) => {
                        const prizeName = getPrizeName(winner.prizeId);
                        acc[prizeName] = (acc[prizeName] || 0) + 1;
                        return acc;
                    }, {}),
                    byDepartment: winners.reduce((acc, winner) => {
                        const employee = employees.find(e => normalizeId(e.id) === normalizeId(winner.employeeId));
                        if (employee) {
                            acc[employee.department] = (acc[employee.department] || 0) + 1;
                        }
                        return acc;
                    }, {})
                },
                system: {
                    bonusActivated: bonusSettings.activated,
                    currentStatus: lotteryState.status,
                    lastUpdate: new Date().toISOString(),
                    version: '2.0-html-fixed'
                }
            };
        }

        // æŠ½çé‚è¼¯å¼•æ“
        function handleLotteryStart(prizeId) {
            console.log('æ”¶åˆ°é–‹å§‹æŠ½çäº‹ä»¶:', prizeId);
            
            lotteryState.status = 'rolling';
            lotteryState.currentPrize = prizeId;
            lotteryState.currentWinner = null;
            
            const eligibleEmployees = getEligibleEmployees(prizeId);
            console.log('ç¬¦åˆæ¢ä»¶å“¡å·¥:', eligibleEmployees);
            
            saveData();
            updateEngineStatus();
            broadcastLotteryState();
        }

        function handleLotteryStop() {
            console.log('æ”¶åˆ°åœæ­¢æŠ½çäº‹ä»¶');
            
            if (lotteryState.status !== 'rolling') return;
            
            const prizeId = lotteryState.currentPrize;
            const eligibleEmployees = getEligibleEmployees(prizeId);
            
            if (eligibleEmployees.length === 0) {
                showNotification('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å“¡å·¥ï¼', 'error');
                lotteryState.status = 'waiting';
                lotteryState.currentPrize = null;
                saveData();
                updateEngineStatus();
                broadcastLotteryState();
                return;
            }
            
            const winner = eligibleEmployees[Math.floor(Math.random() * eligibleEmployees.length)];
            
            const winRecord = {
                id: Date.now(),
                employeeId: normalizeId(winner.id),
                prizeId: prizeId,
                timestamp: new Date().toISOString()
            };
            
            winners.push(winRecord);
            
            if (prizeId !== 'bonus') {
                const prize = findPrizeById(prizeId);
                if (prize) prize.drawn++;
            }
            
            lotteryState.status = 'showing';
            lotteryState.currentWinner = {
                id: normalizeId(winner.id),
                employeeName: winner.name,
                department: winner.department,
                prizeName: getPrizeDisplayName(prizeId)
            };
            
            saveData();
            updateEngineStatus();
            renderWinners();
            updateStats();
            renderPrizes();
            
            broadcastLotteryResult(lotteryState.currentWinner);
            
            console.log('æŠ½ççµæœ:', lotteryState.currentWinner);
            showNotification(`æ­å–œ ${winner.name} ç²å¾— ${lotteryState.currentWinner.prizeName}ï¼`);
            
            setTimeout(() => {
                lotteryState.status = 'waiting';
                lotteryState.currentPrize = null;
                lotteryState.currentWinner = null;
                saveData();
                updateEngineStatus();
                broadcastLotteryState();
            }, 3000);
        }

        function forceLotteryStop() {
            console.log('å¼·åˆ¶åœæ­¢æŠ½ç');
            lotteryState.status = 'waiting';
            lotteryState.currentPrize = null;
            lotteryState.currentWinner = null;
            saveData();
            updateEngineStatus();
            broadcastLotteryState();
            showNotification('æŠ½çå·²å¼·åˆ¶åœæ­¢', 'warning');
        }

        function broadcastLotteryState() {
            const event = {
                type: 'LOTTERY_STATE_CHANGE',
                data: {
                    status: lotteryState.status,
                    currentPrize: lotteryState.currentPrize,
                    eligibleCount: lotteryState.currentPrize ? getEligibleEmployees(lotteryState.currentPrize).length : 0,
                    timestamp: Date.now()
                }
            };
            
            console.log('å»£æ’­æŠ½çç‹€æ…‹:', event);
            localStorage.setItem('lotteryStateUpdate', JSON.stringify(event));
        }

        function broadcastLotteryResult(winner) {
            const event = {
                type: 'LOTTERY_RESULT',
                data: winner
            };
            
            console.log('å»£æ’­æŠ½ççµæœ:', event);
            localStorage.setItem('lotteryResult', JSON.stringify(event));
        }

        // é€šçŸ¥å‡½æ•¸
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // äº‹ä»¶ç›£è½å™¨è¨­ç½®
        document.getElementById('activateBonusBtn').addEventListener('click', activateBonus);
        document.getElementById('bonusSettingsBtn').addEventListener('click', openBonusSettings);

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveData();
                showNotification('è³‡æ–™å·²ä¿å­˜');
            }
            
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportSettings();
            }
            
            if (e.key === 'F5' && !e.ctrlKey) {
                e.preventDefault();
                updateStats();
                renderPrizes();
                renderEmployees();
                renderRules();
                renderWinners();
                showNotification('ä»‹é¢å·²é‡æ–°æ•´ç†');
            }
        });

        // è¦–çª—é—œé–‰å‰ç¢ºèª
        window.addEventListener('beforeunload', function(e) {
            if (lotteryState.status === 'rolling') {
                e.preventDefault();
                e.returnValue = 'æŠ½çæ­£åœ¨é€²è¡Œä¸­ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
                return 'æŠ½çæ­£åœ¨é€²è¡Œä¸­ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
            }
        });

        // éŒ¯èª¤è™•ç†
        window.addEventListener('error', function(e) {
            console.error('ç³»çµ±éŒ¯èª¤:', e.error);
            showNotification('ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°', 'error');
        });

        // æä¾›å…¨åŸŸAPI
        window.LotteryAdmin = {
            getEmployees: () => employees,
            getPrizes: () => prizes,
            getWinners: () => winners,
            getRules: () => rules,
            getBonusSettings: () => bonusSettings,
            getLotteryState: () => lotteryState,
            getSystemReport: getSystemReport,
            getEligibleEmployees: getEligibleEmployees,
            handleLotteryStart: handleLotteryStart,
            handleLotteryStop: handleLotteryStop,
            forceLotteryStop: forceLotteryStop,
            getTopPrizes: getTopPrizes
        };

        console.log('ğŸ¯ æŠ½çç³»çµ±ç®¡ç†å¾Œå° - HTMLçµæ§‹ä¿®å¾©ç‰ˆåˆå§‹åŒ–å®Œæˆ');
        console.log('âœ¨ ä¿®å¾©å…§å®¹:');
        console.log('  1. âœ… ä¿®å¾©HTMLçµæ§‹ - å®Œæ•´çš„HTML/CSS/JSçµæ§‹');
        console.log('  2. âœ… å¯¦ç¾Orderé‚è¼¯ - æŒ‰æŠ½çé †åºæ’åˆ—');
        console.log('  3. âœ… æ–°å¢Contentæ¬„ä½ - çé …å…§å®¹èˆ‡åç¨±åˆ†é›¢');
        console.log('  4. âœ… ä¿®å¾©å‰Nçåˆ¤æ–· - ä½¿ç”¨Orderè€ŒéIDåˆ¤æ–·');
        console.log('  5. âœ… å„ªåŒ–ä»‹é¢ - ç§»é™¤ä¸Šä¸‹èª¿æ•´æŒ‰éˆ•');
        console.log('  6. âœ… åŠ å¼·æŠ½çé‚è¼¯ - æ”¯æ´åŠ ç¢¼çæ’é™¤å‰Nçå¾—ä¸»');
    </script>

<!-- ===== Firebase é ç«¯æ§åˆ¶æ•´åˆ (é–‹å§‹) ===== -->
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

<!-- Firebase ç³»çµ±æª”æ¡ˆ -->
<script src="firebase_config.js"></script>
<script src="firebase_core.js"></script>
<script src="lottery_events.js"></script>

<!-- Firebase æ©‹æ¥å™¨ (è‡ªå‹•è™•ç†æ‰€æœ‰æ•´åˆ) -->
<!-- æ”¹ç‚ºç°¡åŒ–ç‰ˆ -->
<script src="lottery_bridge_simple.js"></script>

<script>
// é¡¯ç¤ºé€£ç·šç‹€æ…‹ï¼ˆå¯é¸ï¼‰
setTimeout(() => {
    if (window.lotteryBridge && window.lotteryBridge.initialized) {
        console.log('âœ… Firebase é ç«¯æ§åˆ¶å·²å•Ÿç”¨');
    }
}, 2000);
</script>
<!-- ===== Firebase é ç«¯æ§åˆ¶æ•´åˆ (çµæŸ) ===== -->

</body>
</html>
